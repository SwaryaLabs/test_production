name: Deploy to cPanel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1Ô∏è‚É£ Get your code
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Upload files to cPanel via SFTP
      - name: üì§ Deploy via SFTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          protocol: ftp # Change to 'ftp' if SFTP is not enabled
          local-dir: ./ # Deploy everything from repo root
          server-dir: ${{ secrets.FTP_SERVER_PATH }}/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/README.md
            .github/**
            .gitignore

      # 3Ô∏è‚É£ SSH into server to install deps & restart app
      - name: üîÑ Install deps & restart Node.js app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT }}
          script: |
            cd ${{ secrets.SERVER_PATH }}
            echo "üì¶ Installing production dependencies..."
            npm install --production --ignore-scripts
            echo "üîÅ Restarting Node.js app (cPanel Passenger)..."
            mkdir -p tmp
            touch tmp/restart.txt
            echo "‚úÖ Deployment complete!"
